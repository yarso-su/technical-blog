---
import Blog from '@/layouts/Blog.astro'
import type { GetStaticPaths, Page } from 'astro'
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const images = import.meta.glob<{ default: ImageMetadata }>(
    '/src/assets/images/*.{jpeg,jpg,png,gif,webp}'
  )
  const rawPosts = await getCollection('blog')
  const posts = await Promise.all(
    rawPosts.map(async post => {
      const imagePath = `/src/assets/images/${post.data.img}`
      const image = await images[imagePath]()

      return {
        id: post.id,
        title: post.data.title,
        description: post.data.description,
        image: image.default,
        createdAt: post.data.published
      }
    })
  ).then(posts =>
    posts.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())
  )

  const paginatedPosts = paginate(posts, { pageSize: 6 }).filter(
    page => page.params.page !== '1'
  )

  return paginatedPosts
}

interface Props {
  page: Page<{
    id: string
    title: string
    description: string
    image: string
    createdAt: string
  }>
}

const { page } = Astro.props

function getPageNumbers(currentPage: number, lastPage: number) {
  const pages = []
  const maxVisible = 3

  let start = Math.max(1, currentPage - Math.floor(maxVisible / 2))
  let end = Math.min(lastPage, start + maxVisible - 1)

  if (end - start + 1 < maxVisible) {
    start = Math.max(1, end - maxVisible + 1)
  }

  for (let i = start; i <= end; i++) {
    pages.push(i)
  }

  return pages
}

const pageNumbers = getPageNumbers(page.currentPage, page.lastPage)
---

<Blog
  title={`Blog (${page.currentPage}). Te contamos cómo funciona el software`}
  description={`Explora el blog de Works con artículos de software, noticias de tecnología y consejos técnicos para optimizar tus proyectos y mantenerte actualizado ${page.currentPage}/${page.lastPage}.`}
  main
>
  <section class="mt-4 mb-6 lg:mb-12 mx-auto 2xl:w-[60%] w-[90%]">
    <h1 class="block">
      <p
        class="leading-[1.5] text-lg lg:text-2xl font-semibold tracking-tight text-contrast flex items-start gap-1"
      >
        Blog <span
          class="opacity-80 font-semibold text-sm lg:text-base text-contrast"
        >
          {page.currentPage}
        </span>
      </p>
      <p
        class="text-black dark:text-white leading-[1.1] text-2xl lg:text-3xl font-semibold tracking-tight"
      >
        Hablemos de software (porque eso es lo que hacemos)
      </p>
    </h1>
    <p class="text-xl mt-4 hidden md:block">
      ¿Alguna vez te has preguntado cómo funciona la tecnología que usas en tu
      día a día?
    </p>
    <p class="text-xl mt-4 hidden md:block">
      Nosotros también. Y por eso queremos compartir lo que sabemos y lo que
      consideramos útil para ti y tus proyectos. Entender los procesos detrás de
      los negocios modernos puede darte las herramientas necesarias para tomar
      mejores decisiones y llevar tus ideas más lejos.
    </p>
    <p class="mt-4 md:hidden text-sm sm:text-lg">
      ¿Te has preguntado cómo funciona la tecnología que usas día a día?
    </p>
    <p class="mt-2 md:hidden text-sm sm:text-lg">
      Nosotros también. Y queremos compartir lo que aprendemos y lo que puede
      servirte en tus proyectos.
    </p>
  </section>
  <section class="bg-secondary border-t-[1px]">
    <div class="mx-auto 2xl:w-[60%] w-[90%] pb-8 pt-8 lg:pt-12">
      <h2
        class="leading-[1.1] text-xl lg:text-2xl font-semibold tracking-tight"
      >
        Nuestros artículos de software y tecnología
        <span class="text-sm lg:text-base font-semibold opacity-80">
          ({page.currentPage}/{page.lastPage})
        </span>
      </h2>
      <p class="mt-4 text-xl hidden md:block">
        Aquí encontrarás lecturas pensadas para ti. ¿Qué es esto? ¿Cómo funciona
        aquello? Si alguna de tus preguntas encuentra respuesta, habremos
        cumplido nuestra misión.
      </p>
      <p class="mt-2 md:hidden text-sm sm:text-lg">
        Aquí encontrarás lecturas pensadas para ti. ¿Qué es esto? ¿Cómo funciona
        aquello?
      </p>
      <ul class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-5">
        {
          page.data.map(post => (
            <li>
              <a href={`/${post.id}/`}>
                <div class="grid grid-cols-[90px_1fr] lg:grid-cols-[120px_1fr] gap-2 items-center hover:scale-[102%] transition-transform duration-350">
                  <Image
                    class="border-[1px] rounded-xs w-full h-auto hover:underline underline-offset-2"
                    src={post.image}
                    width={350}
                    height={400}
                    widths={[300, 350, 500]}
                    sizes="(max-width: 768px) 100vw, (max-width: 1024px) 300px, 350px"
                    format="webp"
                    style={`view-transition-name: ${post.id};`}
                    alt={post.title}
                  />
                  <div>
                    <h3 class="line-clamp-2 font-semibold lg:line-clamp-none leading-[1.2] lg:text-xl w-full text-left lg:font-semibold tracking-tight">
                      {post.title}
                    </h3>
                    <p class="mt-1 opacity-85 line-clamp-1 text-sm lg:text-base ">
                      {post.description}
                    </p>
                  </div>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
      <div class="flex justify-center items-center mt-4 lg:mt-8">
        <nav
          class="flex justify-center items-center gap-2 flex-wrap"
          aria-label="Navegación de páginas"
        >
          <!-- Primera página y anterior -->
          {
            !pageNumbers.some(number => number === 1) && (
              <a
                href="/"
                class="rounded-xs px-4 py-2 hover:bg-black/5 dark:hover:bg-white/5 transition-colors deration-150"
              >
                1
              </a>
            )
          }

          {page.currentPage > 3 && <span class="px-2 text-gray-500">...</span>}

          <!-- Páginas alrededor de la actual -->
          {
            pageNumbers.map(pageNum =>
              pageNum === page.currentPage ? (
                <span
                  class="px-4 py-2 bg-black/5 dark:bg-white/5 rounded-xs font-semibold"
                  aria-current="page"
                >
                  {pageNum}
                </span>
              ) : pageNum === 1 ? (
                <a
                  href="/"
                  class="px-4 py-2 rounded-xs hover:bg-black/5 dark:hover:bg-white/5  transition-colors duration-150"
                >
                  {pageNum}
                </a>
              ) : (
                <a
                  href={`/${pageNum}/`}
                  class="px-4 py-2 rounded-xs hover:bg-black/5 dark:hover:bg-white/5 transition-colors  duration-150"
                >
                  {pageNum}
                </a>
              )
            )
          }

          <!-- Última página -->
          {
            page.currentPage < page.lastPage - 2 && (
              <span class="px-2 text-gray-500">...</span>
            )
          }

          {
            !pageNumbers.some(pageNum => pageNum === page.lastPage) && (
              <a
                href={`/${page.lastPage}/`}
                class="px-4 py-2 rounded-xs hover:bg-black/5 dark:hover:bg-white/5 transition-colors duration-150"
              >
                {page.lastPage}
              </a>
            )
          }
        </nav>
      </div>
    </div>
  </section>
</Blog>
