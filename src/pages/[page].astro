---
import BlogDescription from '@/components/BlogDescription.astro'
import Discover from '@/components/Discover.astro'
import Intro from '@/components/Intro.astro'
import Blog from '@/layouts/Blog.astro'
import type { GetStaticPaths, Page } from 'astro'
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const POSTS_PER_PAGE = 4

  const images = import.meta.glob<{ default: ImageMetadata }>(
    '/src/assets/images/*.{jpeg,jpg,png,gif,webp}'
  )
  const rawPosts = await getCollection('blog')
  const posts = await Promise.all(
    rawPosts.map(async post => {
      const imagePath = `/src/assets/images/${post.data.img}`
      const image = await images[imagePath]()

      return {
        id: post.id,
        title: post.data.title,
        description: post.data.description,
        image: image.default,
        createdAt: post.data.published
      }
    })
  ).then(posts =>
    posts.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())
  )

  const paginatedPosts = paginate(posts, { pageSize: POSTS_PER_PAGE }).filter(
    page => page.params.page !== '1'
  )

  return paginatedPosts
}

interface Props {
  page: Page<{
    id: string
    title: string
    description: string
    image: string
    createdAt: string
  }>
}

const { page } = Astro.props

function getPageNumbers(currentPage: number, lastPage: number) {
  const pages = []
  const maxVisible = 3

  let start = Math.max(1, currentPage - Math.floor(maxVisible / 2))
  let end = Math.min(lastPage, start + maxVisible - 1)

  if (end - start + 1 < maxVisible) {
    start = Math.max(1, end - maxVisible + 1)
  }

  for (let i = start; i <= end; i++) {
    pages.push(i)
  }

  return pages
}

const pageNumbers = getPageNumbers(page.currentPage, page.lastPage)
---

<Blog
  title={`Artículos sobre conceptos de tecnología (${page.currentPage})`}
  description={`Si siempre te has preguntado cómo funcionan las cosas, tal vez puedas encontrar aquí un par de respuestas (${page.currentPage}).`}
  main
>
  <Intro currentPage={page.currentPage} />
  <section class="bg-secondary border-t">
    <div class="mx-auto 2xl:w-[60%] w-[90%] pt-8 lg:pt-12">
      <BlogDescription page={page.currentPage} lastPage={page.lastPage} />
      <ul class="mt-6 md:mt-8 grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-5">
        {
          page.data.map(post => (
            <li>
              <a href={`/${post.id}/`} aria-label={post.title}>
                <div class="grid grid-cols-[90px_1fr] lg:grid-cols-[120px_1fr] gap-2 items-center hover:scale-[102%] transition-transform duration-350">
                  <Image
                    class="border rounded-sm w-full h-auto hover:underline underline-offset-2"
                    src={post.image}
                    width={350}
                    height={400}
                    widths={[300, 350, 500]}
                    sizes="(max-width: 768px) 100vw, (max-width: 1024px) 300px, 350px"
                    format="webp"
                    style={`view-transition-name: ${post.id};`}
                    alt={post.title}
                  />
                  <div>
                    <h3 class="line-clamp-2 font-semibold lg:line-clamp-none leading-[1.2] lg:text-xl w-full text-left lg:font-semibold tracking-tight">
                      {post.title}
                    </h3>
                    <p class="mt-1 opacity-85 line-clamp-1 sm:line-clamp-2 text-sm lg:text-base ">
                      {post.description}
                    </p>
                  </div>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
      <div class="flex justify-center items-center mt-6 lg:mt-8">
        <nav
          class="flex justify-center items-center gap-2 flex-wrap"
          aria-label="Navegación de páginas"
        >
          <!-- Primera página y anterior -->
          {
            !pageNumbers.some(number => number === 1) && (
              <a
                href="/"
                class="rounded-sm px-4 py-2 hover:bg-black/5 dark:hover:bg-white/5 transition-colors deration-150"
              >
                1
              </a>
            )
          }

          {page.currentPage > 3 && <span class="px-2 text-gray-500">...</span>}

          <!-- Páginas alrededor de la actual -->
          {
            pageNumbers.map(pageNum =>
              pageNum === page.currentPage ? (
                <span
                  class="px-4 py-2 bg-black/5 dark:bg-white/5 rounded-sm font-semibold"
                  aria-current="page"
                >
                  {pageNum}
                </span>
              ) : pageNum === 1 ? (
                <a
                  href="/"
                  class="px-4 py-2 rounded-sm hover:bg-black/5 dark:hover:bg-white/5  transition-colors duration-150"
                >
                  {pageNum}
                </a>
              ) : (
                <a
                  href={`/${pageNum}/`}
                  class="px-4 py-2 rounded-sm hover:bg-black/5 dark:hover:bg-white/5 transition-colors  duration-150"
                >
                  {pageNum}
                </a>
              )
            )
          }

          <!-- Última página -->
          {
            page.currentPage < page.lastPage - 2 && (
              <span class="px-2 text-gray-500">...</span>
            )
          }

          {
            !pageNumbers.some(pageNum => pageNum === page.lastPage) && (
              <a
                href={`/${page.lastPage}/`}
                class="px-4 py-2 rounded-sm hover:bg-black/5 dark:hover:bg-white/5 transition-colors duration-150"
              >
                {page.lastPage}
              </a>
            )
          }
        </nav>
      </div>
    </div>
  </section>
  <Discover />
</Blog>
